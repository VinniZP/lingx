// Localeflow Database Schema
// Per Design Doc and ADR-0002 (Copy-on-Write Branch Storage)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String?  // bcrypt hashed (cost factor 12), null for passwordless users
  name        String?
  role        Role     @default(DEVELOPER)
  avatarUrl   String?  // Path to uploaded avatar file
  preferences Json?    // {theme, language, notifications, defaultProjectId}
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // TOTP Two-Factor Authentication
  totpSecret         String?   // AES-256-GCM encrypted TOTP secret
  totpSecretIv       String?   // Initialization vector for decryption
  totpEnabled        Boolean   @default(false)
  totpEnabledAt      DateTime?
  totpFailedAttempts Int       @default(0)
  totpLockedUntil    DateTime?

  // Passwordless / WebAuthn
  passwordlessAt DateTime? // When user went passwordless

  apiKeys              ApiKey[]
  projectMembers       ProjectMember[]
  activities           Activity[]
  emailVerifications   EmailVerification[]
  sessions             Session[]
  backupCodes          BackupCode[]
  webauthnCredentials  WebAuthnCredential[]
  translationApprovals Translation[] @relation("TranslationApprovals")

  @@index([email])
}

model Session {
  id           String    @id @default(cuid())
  userId       String
  deviceInfo   String?   // Parsed browser/OS from user agent
  userAgent    String?   // Raw user agent string
  ipAddress    String?
  lastActive   DateTime  @default(now())
  createdAt    DateTime  @default(now())
  expiresAt    DateTime  // 24h from creation, matches JWT expiry
  trustedUntil DateTime? // 2FA device trust expiry (30 days)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model BackupCode {
  id        String    @id @default(cuid())
  userId    String
  codeHash  String    // bcrypt hash of backup code
  usedAt    DateTime? // null if unused
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model WebAuthnCredential {
  id           String   @id @default(cuid())
  userId       String

  // WebAuthn spec fields
  credentialId String   @unique // Base64URL encoded credential ID
  publicKey    String            // Base64URL encoded COSE public key
  counter      BigInt   @default(0) // Sign count for replay protection
  transports   String[] // ["internal", "usb", "ble", "nfc", "hybrid"]

  // Metadata from attestation
  deviceType String  @default("singleDevice") // singleDevice | multiDevice
  backedUp   Boolean @default(false)
  aaguid     String? // Authenticator AAGUID

  // User-friendly info
  name       String    // User-given name: "MacBook Pro", "iPhone 15"
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model EmailVerification {
  id        String   @id @default(cuid())
  userId    String
  newEmail  String   // The new email being verified
  token     String   @unique // Secure token for verification
  expiresAt DateTime // 24-hour expiry
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

enum Role {
  DEVELOPER
  MANAGER
  ADMIN
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  keyHash     String    @unique // SHA-256 hash of the actual key
  keyPrefix   String    // First 8 chars for identification (lf_...)
  userId      String
  createdAt   DateTime  @default(now())
  lastUsedAt  DateTime?
  revokedAt   DateTime?
  expiresAt   DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([userId])
}

// ============================================
// PROJECT STRUCTURE
// ============================================

model Project {
  id                    String   @id @default(cuid())
  name                  String
  slug                  String   @unique
  description           String?
  defaultLanguage       String   @default("en")
  activityRetentionDays Int      @default(90)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  languages         ProjectLanguage[]
  members           ProjectMember[]
  spaces            Space[]
  environments      Environment[]
  activities        Activity[]
  translationMemory TranslationMemory[]
  mtConfigs         MachineTranslationConfig[]

  @@index([slug])
}

model ProjectLanguage {
  id        String  @id @default(cuid())
  projectId String
  code      String  // ISO 639-1 code (en, es, fr, etc.)
  name      String  // Display name (English, Spanish, French)
  isDefault Boolean @default(false)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, code])
  @@index([projectId])
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole @default(DEVELOPER)
  createdAt DateTime    @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

enum ProjectRole {
  DEVELOPER
  MANAGER
  OWNER
}

// ============================================
// SPACES & BRANCHES (per ADR-0002)
// ============================================

model Space {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  slug        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  branches Branch[]

  @@unique([projectId, slug])
  @@index([projectId])
}

model Branch {
  id             String   @id @default(cuid())
  spaceId        String
  name           String
  slug           String
  isDefault      Boolean  @default(false) // true for 'main' branch
  sourceBranchId String?  // Branch this was created from (null for main)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  space         Space             @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  sourceBranch  Branch?           @relation("BranchToSource", fields: [sourceBranchId], references: [id])
  childBranches Branch[]          @relation("BranchToSource")
  keys          TranslationKey[]
  environments  Environment[]
  activities    Activity[]

  @@unique([spaceId, slug])
  @@index([spaceId])
  @@index([sourceBranchId])
}

// ============================================
// TRANSLATIONS (Copy-on-Write per ADR-0002)
// ============================================

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model TranslationKey {
  id          String   @id @default(cuid())
  branchId    String
  name        String   // The key identifier (e.g., "common.welcome")
  description String?  // Context for translators
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  branch       Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  translations Translation[]

  @@unique([branchId, name])
  @@index([branchId])
  @@index([name])
}

model Translation {
  id        String   @id @default(cuid())
  keyId     String
  language  String   // ISO 639-1 code
  value     String   // The translated text (supports ICU MessageFormat)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Approval workflow
  status          ApprovalStatus @default(PENDING)
  statusUpdatedAt DateTime?
  statusUpdatedBy String?        // userId who approved/rejected

  key        TranslationKey @relation(fields: [keyId], references: [id], onDelete: Cascade)
  statusUser User?          @relation("TranslationApprovals", fields: [statusUpdatedBy], references: [id])

  @@unique([keyId, language])
  @@index([keyId])
  @@index([language])
  @@index([status])
}

// ============================================
// ENVIRONMENTS
// ============================================

model Environment {
  id        String   @id @default(cuid())
  projectId String
  name      String   // e.g., "production", "staging", "development"
  slug      String
  branchId  String   // Points to the active branch for this environment
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  branch  Branch  @relation(fields: [branchId], references: [id])

  @@unique([projectId, slug])
  @@index([projectId])
  @@index([branchId])
}

// ============================================
// REFERENCE DATA
// ============================================

model Language {
  id   String @id @default(cuid())
  code String @unique // ISO 639-1 code
  name String         // Display name

  @@index([code])
}

// ============================================
// ACTIVITY TRACKING (per ADR-0005)
// ============================================

enum ActivityType {
  // Groupable (sequential session-based)
  translation
  key_add
  key_delete

  // Non-groupable (single events)
  branch_create
  branch_delete
  merge
  import
  export
  project_settings
  environment_create
  environment_delete
  environment_switch_branch
  ai_translate
  translation_approve
  translation_reject
}

/// Grouped activity for feed display
/// Uses sequential session-based grouping (15-min gap or type change breaks)
model Activity {
  id        String       @id @default(cuid())
  projectId String
  branchId  String?
  userId    String
  type      ActivityType
  metadata  Json         // Summary + first 10 changes preview
  count     Int          @default(1) // For grouped activities
  groupKey  String       @unique // Enables upsert for grouping
  createdAt DateTime     @default(now())

  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch  Branch?  @relation(fields: [branchId], references: [id], onDelete: SetNull)
  changes ActivityChange[]

  @@index([projectId, createdAt(sort: Desc)])
  @@index([userId])
  @@index([type])
  @@index([branchId])
}

/// Individual changes for full audit trail ("View all" link)
model ActivityChange {
  id         String   @id @default(cuid())
  activityId String
  entityType String   // 'translation', 'key', etc.
  entityId   String   // keyId, translationId, etc.
  keyName    String?  // Denormalized for display without joins
  language   String?  // For translation changes
  oldValue   String?  // null for creates
  newValue   String?  // null for deletes
  createdAt  DateTime @default(now())

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@index([entityId]) // Query: "Who changed this key?"
  @@index([createdAt])
}

// ============================================
// TRANSLATION MEMORY
// ============================================

/// Stores previously translated text for reuse suggestions
/// Uses pg_trgm for fuzzy similarity matching
model TranslationMemory {
  id             String   @id @default(cuid())
  projectId      String
  sourceLanguage String   // Default language code (source)
  targetLanguage String   // Target language code
  sourceText     String   // Original text (indexed for similarity search)
  targetText     String   // Translated text
  usageCount     Int      @default(1) // Times this suggestion was applied
  lastUsedAt     DateTime @default(now())
  sourceKeyId    String?  // Origin key ID for audit trail
  sourceBranchId String?  // Origin branch ID
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // One entry per unique source text per language pair per project
  @@unique([projectId, sourceLanguage, targetLanguage, sourceText])
  @@index([projectId, sourceLanguage, targetLanguage])
}

// ============================================
// MACHINE TRANSLATION
// ============================================

enum MTProvider {
  DEEPL
  GOOGLE_TRANSLATE
}

/// Per-project MT provider configuration
/// API keys are AES-256-GCM encrypted (same pattern as TOTP)
model MachineTranslationConfig {
  id        String     @id @default(cuid())
  projectId String
  provider  MTProvider
  apiKey    String     // AES-256-GCM encrypted API key
  apiKeyIv  String     // Initialization vector for decryption
  isActive  Boolean    @default(true)
  priority  Int        @default(0) // Lower = higher priority for auto-selection
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // One config per provider per project
  @@unique([projectId, provider])
  @@index([projectId])
}

/// Cache MT results to avoid duplicate API calls
/// Indexed by source text hash for fast lookups
model MachineTranslationCache {
  id             String     @id @default(cuid())
  projectId      String
  provider       MTProvider
  sourceLanguage String
  targetLanguage String
  sourceTextHash String     // SHA-256 hash of source text (for indexing)
  sourceText     String     // Original text
  translatedText String     // MT result
  characterCount Int        // For usage tracking
  createdAt      DateTime   @default(now())
  expiresAt      DateTime   // 30-day TTL

  // One cached result per unique source per language pair per provider
  @@unique([projectId, provider, sourceLanguage, targetLanguage, sourceTextHash])
  @@index([projectId, provider, sourceLanguage, targetLanguage])
  @@index([expiresAt]) // For cleanup job
}

/// Track MT usage per project per month for cost estimation
model MachineTranslationUsage {
  id             String     @id @default(cuid())
  projectId      String
  provider       MTProvider
  yearMonth      String     // "2025-01" format for monthly aggregation
  characterCount BigInt     @default(0)
  requestCount   Int        @default(0)
  cachedCount    Int        @default(0) // Requests served from cache
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // One record per project per provider per month
  @@unique([projectId, provider, yearMonth])
  @@index([projectId, yearMonth])
}
