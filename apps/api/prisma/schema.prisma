// Lingx Database Schema
// Per Design Doc and ADR-0002 (Copy-on-Write Branch Storage)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String? // bcrypt hashed (cost factor 12), null for passwordless users
  name        String?
  role        Role     @default(DEVELOPER)
  avatarUrl   String? // Path to uploaded avatar file
  preferences Json? // {theme, language, notifications, defaultProjectId}
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // TOTP Two-Factor Authentication
  totpSecret         String? // AES-256-GCM encrypted TOTP secret
  totpSecretIv       String? // Initialization vector for decryption
  totpEnabled        Boolean   @default(false)
  totpEnabledAt      DateTime?
  totpFailedAttempts Int       @default(0)
  totpLockedUntil    DateTime?

  // Passwordless / WebAuthn
  passwordlessAt DateTime? // When user went passwordless

  // Admin disable/suspend
  isDisabled   Boolean   @default(false)
  disabledAt   DateTime?
  disabledById String?

  apiKeys              ApiKey[]
  projectMembers       ProjectMember[]
  activities           Activity[]
  emailVerifications   EmailVerification[]
  sessions             Session[]
  backupCodes          BackupCode[]
  webauthnCredentials  WebAuthnCredential[]
  translationApprovals Translation[]        @relation("TranslationApprovals")
  disabledBy           User?                @relation("DisabledUsers", fields: [disabledById], references: [id], onDelete: SetNull)
  disabledUsers        User[]               @relation("DisabledUsers")
  sentInvitations      ProjectInvitation[]  @relation("SentInvitations")
  auditLogsPerformed   AuditLog[]           @relation("AuditLogAdmin")

  @@index([email])
}

model Session {
  id           String    @id @default(cuid())
  userId       String
  deviceInfo   String? // Parsed browser/OS from user agent
  userAgent    String? // Raw user agent string
  ipAddress    String?
  lastActive   DateTime  @default(now())
  createdAt    DateTime  @default(now())
  expiresAt    DateTime // 24h from creation, matches JWT expiry
  trustedUntil DateTime? // 2FA device trust expiry (30 days)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model BackupCode {
  id        String    @id @default(cuid())
  userId    String
  codeHash  String // bcrypt hash of backup code
  usedAt    DateTime? // null if unused
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model WebAuthnCredential {
  id     String @id @default(cuid())
  userId String

  // WebAuthn spec fields
  credentialId String   @unique // Base64URL encoded credential ID
  publicKey    String // Base64URL encoded COSE public key
  counter      BigInt   @default(0) // Sign count for replay protection
  transports   String[] // ["internal", "usb", "ble", "nfc", "hybrid"]

  // Metadata from attestation
  deviceType String  @default("singleDevice") // singleDevice | multiDevice
  backedUp   Boolean @default(false)
  aaguid     String? // Authenticator AAGUID

  // User-friendly info
  name       String // User-given name: "MacBook Pro", "iPhone 15"
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model EmailVerification {
  id        String   @id @default(cuid())
  userId    String
  newEmail  String // The new email being verified
  token     String   @unique // Secure token for verification
  expiresAt DateTime // 24-hour expiry
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

enum Role {
  DEVELOPER
  MANAGER
  ADMIN
}

model ApiKey {
  id         String    @id @default(cuid())
  name       String
  keyHash    String    @unique // SHA-256 hash of the actual key
  keyPrefix  String // First 8 chars for identification (lf_...)
  userId     String
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?
  revokedAt  DateTime?
  expiresAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([userId])
}

// ============================================
// PROJECT STRUCTURE
// ============================================

model Project {
  id                    String   @id @default(cuid())
  name                  String
  slug                  String   @unique
  description           String?
  defaultLanguage       String   @default("en")
  activityRetentionDays Int      @default(90)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  languages            ProjectLanguage[]
  members              ProjectMember[]
  spaces               Space[]
  environments         Environment[]
  activities           Activity[]
  translationMemory    TranslationMemory[]
  mtConfigs            MachineTranslationConfig[]
  aiConfigs            AITranslationConfig[]
  aiContextConfig      AIContextConfig?
  glossaryEntries      GlossaryEntry[]
  glossaryTags         GlossaryTag[]
  qualityScoringConfig QualityScoringConfig?
  invitations          ProjectInvitation[]

  @@index([slug])
}

model ProjectLanguage {
  id        String  @id @default(cuid())
  projectId String
  code      String // ISO 639-1 code (en, es, fr, etc.)
  name      String // Display name (English, Spanish, French)
  isDefault Boolean @default(false)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, code])
  @@index([projectId])
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole @default(DEVELOPER)
  createdAt DateTime    @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

enum ProjectRole {
  DEVELOPER
  MANAGER
  OWNER
}

model ProjectInvitation {
  id          String      @id @default(cuid())
  projectId   String
  email       String      // Invitee email (may not be a user yet)
  role        ProjectRole @default(DEVELOPER)
  token       String      @unique
  invitedById String
  expiresAt   DateTime
  acceptedAt  DateTime?
  revokedAt   DateTime?
  createdAt   DateTime    @default(now())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invitedBy User    @relation("SentInvitations", fields: [invitedById], references: [id], onDelete: Cascade)

  // Note: Uniqueness of pending invitations is enforced at application level
  // via findPendingByEmail check, allowing re-inviting after revocation
  @@index([token])
  @@index([email])
  @@index([projectId])
}

// ============================================
// SPACES & BRANCHES (per ADR-0002)
// ============================================

model Space {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  slug        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  branches Branch[]

  @@unique([projectId, slug])
  @@index([projectId])
}

model Branch {
  id             String   @id @default(cuid())
  spaceId        String
  name           String
  slug           String
  isDefault      Boolean  @default(false) // true for 'main' branch
  sourceBranchId String? // Branch this was created from (null for main)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  space         Space            @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  sourceBranch  Branch?          @relation("BranchToSource", fields: [sourceBranchId], references: [id])
  childBranches Branch[]         @relation("BranchToSource")
  keys          TranslationKey[]
  environments  Environment[]
  activities    Activity[]

  @@unique([spaceId, slug])
  @@index([spaceId])
  @@index([sourceBranchId])
}

// ============================================
// TRANSLATIONS (Copy-on-Write per ADR-0002)
// ============================================

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RelationshipType {
  SAME_FILE // Keys extracted from same source file
  SAME_COMPONENT // Keys from same React component/function scope
  SEMANTIC // Text similarity in source translations
  NEARBY // Keys within 30 lines of each other (line proximity)
  KEY_PATTERN // Keys with similar naming patterns (e.g., form.email.*)
}

model TranslationKey {
  id          String   @id @default(cuid())
  branchId    String
  namespace   String? // Optional namespace for grouping (null = root)
  name        String // The key identifier (e.g., "common.welcome")
  description String? // Context for translators
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Source location metadata (from CLI extraction)
  sourceFile      String? // Relative path: "src/components/Header.tsx"
  sourceLine      Int? // Line number in file
  sourceComponent String? // Component/function name: "HeaderNav"

  branch       Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  translations Translation[]

  // Key relationships for near-key context
  relationshipsFrom KeyRelationship[] @relation("FromKey")
  relationshipsTo   KeyRelationship[] @relation("ToKey")

  @@unique([branchId, namespace, name])
  @@index([branchId])
  @@index([branchId, namespace])
  @@index([name])
  @@index([sourceFile])
  @@index([sourceComponent])
}

model Translation {
  id        String   @id @default(cuid())
  keyId     String
  language  String // ISO 639-1 code
  value     String // The translated text (supports ICU MessageFormat)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Approval workflow
  status          ApprovalStatus @default(PENDING)
  statusUpdatedAt DateTime?
  statusUpdatedBy String? // userId who approved/rejected

  key          TranslationKey           @relation(fields: [keyId], references: [id], onDelete: Cascade)
  statusUser   User?                    @relation("TranslationApprovals", fields: [statusUpdatedBy], references: [id])
  qualityScore TranslationQualityScore?

  @@unique([keyId, language])
  @@index([keyId])
  @@index([language])
  @@index([status])
}

model KeyRelationship {
  id         String           @id @default(cuid())
  fromKeyId  String
  toKeyId    String
  type       RelationshipType
  confidence Float            @default(1.0) // 0.0-1.0, useful for SEMANTIC
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  fromKey TranslationKey @relation("FromKey", fields: [fromKeyId], references: [id], onDelete: Cascade)
  toKey   TranslationKey @relation("ToKey", fields: [toKeyId], references: [id], onDelete: Cascade)

  @@unique([fromKeyId, toKeyId, type])
  @@index([fromKeyId])
  @@index([toKeyId])
  @@index([type])
}

// ============================================
// ENVIRONMENTS
// ============================================

model Environment {
  id        String   @id @default(cuid())
  projectId String
  name      String // e.g., "production", "staging", "development"
  slug      String
  branchId  String // Points to the active branch for this environment
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  branch  Branch  @relation(fields: [branchId], references: [id])

  @@unique([projectId, slug])
  @@index([projectId])
  @@index([branchId])
}

// ============================================
// REFERENCE DATA
// ============================================

model Language {
  id   String @id @default(cuid())
  code String @unique // ISO 639-1 code
  name String // Display name

  @@index([code])
}

// ============================================
// ACTIVITY TRACKING (per ADR-0005)
// ============================================

enum ActivityType {
  // Groupable (sequential session-based)
  translation
  key_add
  key_delete

  // Non-groupable (single events)
  branch_create
  branch_delete
  merge
  import
  export
  project_settings
  environment_create
  environment_update
  environment_delete
  environment_switch_branch
  ai_translate
  translation_approve
  translation_reject
}

/// Grouped activity for feed display
/// Uses sequential session-based grouping (15-min gap or type change breaks)
model Activity {
  id        String       @id @default(cuid())
  projectId String
  branchId  String?
  userId    String
  type      ActivityType
  metadata  Json // Summary + first 10 changes preview
  count     Int          @default(1) // For grouped activities
  groupKey  String       @unique // Enables upsert for grouping
  createdAt DateTime     @default(now())

  project Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch  Branch?          @relation(fields: [branchId], references: [id], onDelete: SetNull)
  changes ActivityChange[]

  @@index([projectId, createdAt(sort: Desc)])
  @@index([userId])
  @@index([type])
  @@index([branchId])
}

/// Individual changes for full audit trail ("View all" link)
model ActivityChange {
  id         String   @id @default(cuid())
  activityId String
  entityType String // 'translation', 'key', etc.
  entityId   String // keyId, translationId, etc.
  keyName    String? // Denormalized for display without joins
  language   String? // For translation changes
  oldValue   String? // null for creates
  newValue   String? // null for deletes
  createdAt  DateTime @default(now())

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@index([entityId]) // Query: "Who changed this key?"
  @@index([createdAt])
}

// ============================================
// TRANSLATION MEMORY
// ============================================

/// Stores previously translated text for reuse suggestions
/// Uses pg_trgm for fuzzy similarity matching
model TranslationMemory {
  id             String   @id @default(cuid())
  projectId      String
  sourceLanguage String // Default language code (source)
  targetLanguage String // Target language code
  sourceText     String // Original text (indexed for similarity search)
  targetText     String // Translated text
  usageCount     Int      @default(1) // Times this suggestion was applied
  lastUsedAt     DateTime @default(now())
  sourceKeyId    String? // Origin key ID for audit trail
  sourceBranchId String? // Origin branch ID
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // One entry per unique source text per language pair per project
  @@unique([projectId, sourceLanguage, targetLanguage, sourceText])
  @@index([projectId, sourceLanguage, targetLanguage])
}

// ============================================
// MACHINE TRANSLATION
// ============================================

enum MTProvider {
  DEEPL
  GOOGLE_TRANSLATE
}

// ============================================
// AI TRANSLATION (per ADR - AI-Powered Translation)
// ============================================

enum AIProvider {
  OPENAI
  ANTHROPIC
  GOOGLE_AI
  MISTRAL
}

/// Per-project MT provider configuration
/// API keys are AES-256-GCM encrypted (same pattern as TOTP)
model MachineTranslationConfig {
  id        String     @id @default(cuid())
  projectId String
  provider  MTProvider
  apiKey    String // AES-256-GCM encrypted API key
  apiKeyIv  String // Initialization vector for decryption
  isActive  Boolean    @default(true)
  priority  Int        @default(0) // Lower = higher priority for auto-selection
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // One config per provider per project
  @@unique([projectId, provider])
  @@index([projectId])
}

/// Cache MT results to avoid duplicate API calls
/// Indexed by source text hash for fast lookups
model MachineTranslationCache {
  id             String     @id @default(cuid())
  projectId      String
  provider       MTProvider
  sourceLanguage String
  targetLanguage String
  sourceTextHash String // SHA-256 hash of source text (for indexing)
  sourceText     String // Original text
  translatedText String // MT result
  characterCount Int // For usage tracking
  createdAt      DateTime   @default(now())
  expiresAt      DateTime // 30-day TTL

  // One cached result per unique source per language pair per provider
  @@unique([projectId, provider, sourceLanguage, targetLanguage, sourceTextHash])
  @@index([projectId, provider, sourceLanguage, targetLanguage])
  @@index([expiresAt]) // For cleanup job
}

/// Track MT usage per project per month for cost estimation
model MachineTranslationUsage {
  id             String     @id @default(cuid())
  projectId      String
  provider       MTProvider
  yearMonth      String // "2025-01" format for monthly aggregation
  characterCount BigInt     @default(0)
  requestCount   Int        @default(0)
  cachedCount    Int        @default(0) // Requests served from cache
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // One record per project per provider per month
  @@unique([projectId, provider, yearMonth])
  @@index([projectId, yearMonth])
}

/// Per-project AI provider configuration
/// API keys are AES-256-GCM encrypted (same pattern as MT)
model AITranslationConfig {
  id        String     @id @default(cuid())
  projectId String
  provider  AIProvider
  apiKey    String // AES-256-GCM encrypted API key
  apiKeyIv  String // Initialization vector for decryption
  model     String // e.g., "gpt-4o-mini", "claude-3-5-sonnet-latest"
  isActive  Boolean    @default(true)
  priority  Int        @default(0) // Lower = higher priority for auto-selection
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // One config per provider per project
  @@unique([projectId, provider])
  @@index([projectId])
}

/// Per-project AI context configuration
/// Controls what context is included in AI translation prompts
model AIContextConfig {
  id                 String   @id @default(cuid())
  projectId          String   @unique
  includeGlossary    Boolean  @default(true) // Include matching glossary terms
  glossaryLimit      Int      @default(10) // Max glossary terms to include
  includeTM          Boolean  @default(true) // Include TM fuzzy matches
  tmLimit            Int      @default(5) // Max TM matches to include
  tmMinSimilarity    Float    @default(0.7) // Min similarity (0.0-1.0)
  includeRelatedKeys Boolean  @default(true) // Include related key translations
  relatedKeysLimit   Int      @default(5) // Max related keys to include
  includeDescription Boolean  @default(true) // Include project description
  customInstructions String?  @db.Text // Custom prompt additions
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

/// Cache AI translation results to avoid duplicate API calls
/// Indexed by source text hash for fast lookups (same pattern as MT cache)
model AITranslationCache {
  id             String     @id @default(cuid())
  projectId      String
  provider       AIProvider
  model          String
  sourceLanguage String
  targetLanguage String
  sourceTextHash String // SHA-256 hash of source text (for indexing)
  sourceText     String     @db.Text // Original text
  translatedText String     @db.Text // AI result
  tokenCount     Int // Total tokens used (input + output)
  createdAt      DateTime   @default(now())
  expiresAt      DateTime // 30-day TTL

  // One cached result per unique source per language pair per model
  @@unique([projectId, provider, model, sourceLanguage, targetLanguage, sourceTextHash])
  @@index([projectId, provider, sourceLanguage, targetLanguage])
  @@index([expiresAt]) // For cleanup job
}

/// Track AI usage per project per month for cost estimation
model AITranslationUsage {
  id           String     @id @default(cuid())
  projectId    String
  provider     AIProvider
  model        String
  yearMonth    String // "2025-01" format for monthly aggregation
  inputTokens  BigInt     @default(0) // Prompt tokens
  outputTokens BigInt     @default(0) // Completion tokens
  requestCount Int        @default(0)
  cacheHits    Int        @default(0) // Requests served from cache
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // One record per project per provider per model per month
  @@unique([projectId, provider, model, yearMonth])
  @@index([projectId, yearMonth])
}

// ============================================
// GLOSSARY / TERMBASE
// ============================================

enum PartOfSpeech {
  NOUN
  VERB
  ADJECTIVE
  ADVERB
  PRONOUN
  PREPOSITION
  CONJUNCTION
  INTERJECTION
  DETERMINER
  OTHER
}

/// Stores glossary/terminology entries for consistent translation
/// Per-project scope with rich metadata for professional terminology management
model GlossaryEntry {
  id             String        @id @default(cuid())
  projectId      String
  sourceTerm     String // Term in source language
  sourceLanguage String // ISO 639-1 code
  context        String? // Usage context description
  notes          String? // Additional notes for translators
  partOfSpeech   PartOfSpeech?
  caseSensitive  Boolean       @default(false)
  domain         String? // Subject domain (legal, medical, tech, etc.)
  usageCount     Int           @default(0) // Times this term was applied
  lastUsedAt     DateTime?
  createdBy      String? // userId who created
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  project      Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  translations GlossaryTranslation[]
  tags         GlossaryEntryTag[]

  // One term per source language per project (case handled in code)
  @@unique([projectId, sourceLanguage, sourceTerm])
  @@index([projectId, sourceLanguage])
  @@index([projectId])
}

/// Stores translations for each glossary entry
model GlossaryTranslation {
  id             String   @id @default(cuid())
  entryId        String
  targetLanguage String // ISO 639-1 code
  targetTerm     String // Translated term
  notes          String? // Language-specific notes
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  entry GlossaryEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  // One translation per language per entry
  @@unique([entryId, targetLanguage])
  @@index([entryId])
}

/// Tags for organizing glossary entries
model GlossaryTag {
  id        String   @id @default(cuid())
  projectId String
  name      String
  color     String? // Hex color for UI display
  createdAt DateTime @default(now())

  project Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  entries GlossaryEntryTag[]

  @@unique([projectId, name])
  @@index([projectId])
}

/// Many-to-many relation between entries and tags
model GlossaryEntryTag {
  entryId String
  tagId   String

  entry GlossaryEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  tag   GlossaryTag   @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([entryId, tagId])
  @@index([entryId])
  @@index([tagId])
}


// ============================================
// QUALITY ESTIMATION
// ============================================

/// Stores quality scores for translations (0-100 score)
/// Supports both heuristic (free, fast) and AI evaluation (cost, slow)
model TranslationQualityScore {
  id           String   @id @default(cuid())
  translationId String   @unique
  translation   Translation @relation(fields: [translationId], references: [id], onDelete: Cascade)

  // Overall score 0-100
  score Int

  // Dimension breakdown (nullable - only set for AI evaluation)
  accuracyScore    Int? // AI: semantic fidelity to source
  fluencyScore     Int? // AI: natural language quality
  terminologyScore Int? // Glossary + AI: domain terms
  formatScore      Int  // Heuristic: ICU, placeholders, length

  // Evaluation metadata
  evaluationType String  // "heuristic" | "ai" | "hybrid"
  provider       String? // AI provider used (if any)
  model          String? // Model used (if any)

  // Issues found (JSON array of QualityIssue objects)
  issues Json // QualityIssue[]

  // Token usage for cost tracking
  inputTokens  Int @default(0)
  outputTokens Int @default(0)

  // Content hash for cache validation (hash of source+target)
  // If content changes, score needs re-evaluation
  contentHash String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([score])
  @@index([evaluationType])
  @@index([contentHash])
  // Composite index for cache lookup pattern (translationId + contentHash validation)
  @@index([translationId, contentHash])
}

/// Configuration for quality scoring per project
model QualityScoringConfig {
  id        String   @id @default(cuid())
  projectId String   @unique
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Triggers - when to run quality scoring
  scoreAfterAITranslation Boolean @default(true)
  scoreBeforeMerge        Boolean @default(false)

  // Thresholds - score ranges for quality tiers
  autoApproveThreshold Int @default(80) // >=80 = auto-approve
  flagThreshold        Int @default(60) // <60 = flag for review

  // AI evaluation settings
  aiEvaluationEnabled  Boolean @default(true)
  aiEvaluationProvider String? // null = use project default
  aiEvaluationModel    String? // null = use provider default

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// ADMIN AUDIT LOG
// ============================================

/// Audit log for admin actions (disable, enable, impersonate)
/// Captures before/after state and request context for compliance
model AuditLog {
  id          String   @id @default(cuid())
  adminId     String
  action      String // 'USER_DISABLED' | 'USER_ENABLED' | 'USER_IMPERSONATED'
  targetType  String // 'USER'
  targetId    String
  beforeState Json? // State before action
  afterState  Json? // State after action
  metadata    Json? // Additional context (e.g., tokenExpiry for impersonation)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  admin User @relation("AuditLogAdmin", fields: [adminId], references: [id])

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@index([action])
}
